秒杀系统设计：

### 一. 业务特色

​	1.瞬时并发量大

​	(1) 大量用户会同时进行抢购

​	(2) 网站瞬时访问流量激增

​	2.库存少

​	(1) 访问请求数量远远大于库存数量

​	(2) 只有少部分用户能秒杀成功

​	3.业务流程简单

​	流程比较简单，一般都是下订单，扣库存，支付订单

### 二. 技术难点

 1. 现有业务的冲击

    ​&#160; &#160; &#160; &#160;秒杀是营销活动的一种，如果和其他营销活动应用部署在同一服务器上，肯定会对现有的其他业务造成冲击，极端情况下可能导致整个电商系统服务宕机。

 2. 上游拦截

    ​&#160; &#160; &#160; &#160;下单页面是一个正常的URL地址，需要控制在秒杀开始前，不能下单，只能浏览对应的活动商品的信息。简单来说，需要disable订单按钮。

 3. 页面流量突增

    ​&#160; &#160; &#160; &#160;秒杀活动开始前，会有很多用户请求对应商品页面，会造成后台服务器的流量突增，同时对应的网络宽带增加，需要控制商品页面的流量不会对后台服务器，数据库，Redis等组件造成过大压力。

### 三. 架构设计思想

 1. 限流

    ​&#160; &#160; &#160; &#160;由于活动库存量一般都是很少，相应的只有少部分用户才能秒杀成功。所以我们需要限制大部分用户流量，只准少量用户流量进入后端服务器。

 2. 削峰

    ​&#160; &#160; &#160; &#160;秒杀开始的瞬间，会有大量用户冲击进来，所以在开始时候会有一个瞬间流量峰值。如何把瞬间的流量峰值变得更加平缓，是能否设计好秒杀系统的关键因素。实现流量削峰填谷，一般采用缓存和MQ中间件来解决。

**消息队列特点**

1. 解耦：将信息写入消息队列，需要消息的系统自己从消息队列中订阅，从而让写入系统不需要任何修改。
2. 异步：传统模式每个系统需要串行在一起，一些非必要业务逻辑以同步的方式运行，太耗费时间。中间件模式中，非必要的业务逻辑以异步的方式运行，加快相应速度。
3. 削峰：传统模式中，并发量大的时间，所有的请求直接怼到数据库，造成数据库链接异常。

&#160; &#160; &#160; &#160;中间件模式中系统可以慢慢的按照数据库能处理的并发量从消息队列里慢慢拉取消息。在生产中，这个短暂的高峰挤压是允许的。

**消息队列的缺点**

   1. 系统的可用性降低（引入集群）：因为一旦消息队列挂了，系统就无法正常处理业务了

   2. 系统复杂性增加：加入了消息队列，要考虑很多方面的问题，比如：一致性问题、如何保证消息不会被重复消费（引入验证机制，Redis还会创建消费记录先去查询消费记录即可）、如何保证消息可靠性传输等（引入ACK(包含消息的唯一的ID)）。
       因此，需要考虑的东西很多，刺痛复杂性增加了。

   3. 异步

      ​&#160; &#160; &#160; &#160;秒杀其实可以当成高并发系统来处理，在这个时候，可以考虑从业务上做兼容，将同步的业务，设计成异步处理业务，提高网站的整体可用性。

   4. 缓存
   
      ​&#160; &#160; &#160; &#160;秒杀系统的瓶颈主要体现在下订单，减库存的流程中。在这些流程中主要用到OLTP (On-Line Transaction Processing 联机事务处理过程)的数据库，类似MySQL, SQLServer, Oracle。

&#160; &#160; &#160; &#160;由于数据库底层采用B+树的存储结构，对应我们随机写入与读取的效率相对较低。如果我们把部分业务逻辑迁移到内存的缓存或者Redis中，会极大的提高并发效率。

### 四. 秒杀整体流程

​&#160; &#160; &#160; &#160;秒杀系统核心在于层层过滤，逐渐递减瞬时访问压力，减少最终对数据库的冲击。MQ排队服务就是压力最大的地方，只要MQ排队服务顶住，后面的下订单与减库存的压力都是自己能控制的。

​&#160; &#160; &#160; &#160;根据数据库的压力，可以定制化创建订单消费者的数量，避免出现消费者数据过多，导致数据库压力过大或者直接宕机。库存服务专门为秒杀的商品提供库存管理，实现提前锁定库存，避免超卖现象。

​&#160; &#160; &#160; &#160;同时通过超时处理任务发现以抢到商品，但未付款的订单，并在规定付款时间后，处理这些订单，将恢复订单商品对应的库存里



### 总结：
核心思想是层层过滤；尽量将请求拦截在上游，降低下游压力；充分利用消息队列，提高请求处理速度以及削峰填谷的作用
